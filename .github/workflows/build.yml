name: Compila documento LaTeX
on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
  push:
    branches:
      - main                    # Push events on main branch
      - preview                 # Push events on develop branch
    paths-ignore:
      - '.*/**'                        # ignores dotted folders
      - '!.github/workflows/build.yml' # un-ignores this workflow
      - 'docs/**'                      # ignores documentation
      - '**.bat'                       # ignores windows scripts
      - '**.yml'                       # ignores yaml files
      - '**.md'                        # ignores doc files
  pull_request:
    types: [opened, reopened, synchronize]
    paths-ignore:
      - '.*/**'                        # ignores dotted folders
      - '!.github/workflows/build.yml' # un-ignores this workflow
      - 'docs/**'                      # ignores documentation
      - '**.bat'                       # ignores windows scripts
      - '**.yml'                       # ignores yaml files
      - '**.md'                        # ignores doc files
jobs:

  lint_code_base:
    name: üßπ‚ú® Lint Code Base
    runs-on: ubuntu-latest
    steps:

      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          # Full git history is needed to get a proper list of changed files within `super-linter`
          fetch-depth: 0

      - name: Lint Code Base
        uses: github/super-linter@v3.15.5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEFAULT_BRANCH: main
          VALIDATE_LATEX: true

  build_docs:
    name: 0. ‚öôÔ∏è Compila documento
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      RUN_NUMBER: ${{ github.run_number }}
    outputs:
      tag_part: ${{ steps.tag-version.outputs.part }}
      new_tag: ${{ steps.tag-version.outputs.new_tag }}
      changelog: ${{ steps.tag-version.outputs.changelog }}
      zip_name: ${{ steps.naming-objects.outputs.ZIP_NAME }}
      main_name: ${{ steps.naming-objects.outputs.MAIN_NAME }}
    steps:

      # Print useful references
      - name: Step 0 üëÄ - Print enviroment variables
        run: |
          # USEFUL REFERENCES
          # https://stackoverflow.com/questions/16553089/dynamic-variable-names-in-bash
          print_var () { var=$1 ; printf '%18s %s\n' "$var:" "${!var}"; }
          print_var "CI"
          print_var "GITHUB_WORKFLOW"
          print_var "GITHUB_RUN_ID"
          print_var "GITHUB_RUN_NUMBER"
          print_var "GITHUB_ACTION"
          print_var "GITHUB_ACTIONS"
          print_var "GITHUB_ACTOR"
          print_var "GITHUB_REPOSITORY"
          print_var "GITHUB_EVENT_NAME"
          print_var "GITHUB_WORKSPACE"
          print_var "GITHUB_SHA"
          print_var "GITHUB_REF"
          print_var "GITHUB_HEAD_REF" # only for pull requests
          print_var "GITHUB_BASE_REF" # only for pull requests

      # Set up container
      - name: Step 1 ‚òï - (1/3) Set up Java
        uses: actions/setup-java@v1
        with:
          java-version: '11'

      - name: Step 1 üêç - (2/3) Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8' # last cached version

      - name: Step 1 üêç - (3/3) Set up Python dependencies
        id: setup-python-dependencies
        run: pip install Pygments

      # Checkout branch and set environment variables
      - name: Step 2 üîΩ - (1/2) Checkout the HEAD
        uses: actions/checkout@v2

      - name: Step 2 üå± - (2/2) Setting environment variables
        run: |
          # FOLDERS
          echo "ROOT_DIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV
          echo "BUILD_DIR=$GITHUB_WORKSPACE/src/build" >> $GITHUB_ENV
          echo "SCRIPTS_DIR=$GITHUB_WORKSPACE/src/scripts/unix" >> $GITHUB_ENV

      # Tag version document
      - name: Step 3 üè∑Ô∏è - Bump version & push tag
        if: ${{ success() }}
        id: tag-version
        uses: anothrNick/github-tag-action@master
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_BRANCHES: main
          DEFAULT_BUMP: patch
          # DRY_RUN: true

      # Compile LaTeX document
      - name: Step 4 ‚öôÔ∏è - (1/2) Compile LaTeX documents
        uses: xu-cheng/texlive-action/full@v1
        env:
          NEW_TAG: ${{ steps.tag-version.outputs.new_tag }}
        with:
          run: |
            source $SCRIPTS_DIR/tag-document.sh
            setDocumentVersion $NEW_TAG
            $SCRIPTS_DIR/compile-project.sh

      - name: Step 4 üëÄ - (2/2) Log build
        working-directory: ${{ env.SCRIPTS_DIR }}
        run: |
          source ./check-files.sh
          isCompilationRanCorrectly

      # Compress documents
      - name: Step 5 üëª - (1/3) Install pdfsizeopt from source
        working-directory: ${{ env.ROOT_DIR }}
        env:
          PDFSIZEOPT_FOLDER: bin/pdfsizeopt
          PDFSIZEOPT_TGZ_URL: https://github.com/pts/pdfsizeopt/releases/download/2017-01-24/pdfsizeopt_libexec_linux-v3.tar.gz
          PDFSIZEOPT_TGZ: pdfsizeopt_libexec_linux.tar.gz
          PDFSIZEOPT_BIN_URL: https://raw.githubusercontent.com/pts/pdfsizeopt/master/pdfsizeopt.single
          PDFSIZEOPT_BIN: pdfsizeopt.single
          PDFSIZEOPT: pdfsizeopt
        run: |
          mkdir -p $PDFSIZEOPT_FOLDER
          cd $PDFSIZEOPT_FOLDER
          wget -q -O $PDFSIZEOPT_TGZ $PDFSIZEOPT_TGZ_URL
          tar -xzf $PDFSIZEOPT_TGZ
          rm -f $PDFSIZEOPT_TGZ
          wget -q -O $PDFSIZEOPT_BIN $PDFSIZEOPT_BIN_URL
          chmod +x $PDFSIZEOPT_BIN
          ln -s $PDFSIZEOPT_BIN $PDFSIZEOPT
          echo "$ROOT_DIR/$PDFSIZEOPT_FOLDER/" >> $GITHUB_PATH

      - name: Step 5 üëª - (2/3) Install ghostscript from source
        working-directory: ${{ env.ROOT_DIR }}
        env:
          GS_FOLDER: bin/ghostscript
          GS_TGZ_URL: https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9533/ghostscript-9.53.3-linux-x86_64.tgz
          GS_TGZ: ghostscript-9.53.3-linux-x86_64.tgz
          GS_VERSION: ghostscript-9.53.3-linux-x86_64
          GS_BIN: gs-9533-linux-x86_64
          GS: ghostscript
        run: |
          mkdir -p $GS_FOLDER
          cd $GS_FOLDER
          wget -q -O $GS_TGZ $GS_TGZ_URL
          tar -xzf $GS_TGZ
          rm -f $GS_TGZ
          cd $GS_VERSION
          ln -s $GS_BIN $GS
          echo "$GITHUB_WORKSPACE/bin/ghostscript/$GS_VERSION/" >> $GITHUB_PATH

      - name: Step 5 üëª - (3/3) Compress files
        working-directory: ${{ env.SCRIPTS_DIR }}
        run: ./optimize-size.sh

      # Prepare variables used to naming the files
      - name: Step 6 üå± - (1/2) Get current time
        uses: 1466587594/get-current-time@v2
        id: current-time
        with:
          format: YYYY.MM.DD-HH.mm
          utcOffset: "+01:00"

      - name: Step 6 üå± - (2/2) Setting environment variables
        id: naming-objects
        env:
          TAG: ${{ steps.tag-version.outputs.new_tag }}
          TIME: ${{ steps.current-time.outputs.formattedTime }}
        run: |
          echo "ZIP_NAME=dispensa-$TAG-$TIME" >> $GITHUB_ENV
          echo "MAIN_NAME=main-$TAG-$TIME" >> $GITHUB_ENV
          echo "::set-output name=ZIP_NAME::dispensa-$TAG-$TIME"
          echo "::set-output name=MAIN_NAME::main-$TAG-$TIME"

      # Create folder with PDFs
      - name: Step 7 üîß - Create folder with PDFs
        working-directory: ${{ env.BUILD_DIR }}
        run: |
          mkdir $ZIP_NAME
          mv main.pdf $MAIN_NAME.pdf
          sudo mv -t $ZIP_NAME chapters $MAIN_NAME.pdf

      - name: ‚ö†Ô∏è NOTIFICA FALLIMENTO BUILD ‚ö†Ô∏è
        if: ${{ failure() }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            @emanuelenardi
            build #${{ env.RUN_NUMBER }} ‚öôÔ∏è *fallita* ‚ùå
            [see log run](${{ env.RUN_URL }}) üëÄ

            ``${{ github.event.head_commit.message }}``
          format: markdown
          disable_web_page_preview: true

      - name: Step 8 ‚è´ - Upload artifact to Github
        if: ${{ success() }}
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.ZIP_NAME }}
          path: |
            ${{ env.BUILD_DIR }}
            !${{ env.BUILD_DIR }}/.gitignore
          if-no-files-found: error
          retention-days: 7

  send_docs:
    name: 1. ‚úàÔ∏è Manda zip su Telegram
    runs-on: ubuntu-latest
    needs: build_docs
    env:
      ZIP_NAME: ${{ needs.build_docs.outputs.zip_name }}
    steps:

      - name: Step 1 ‚è¨ - Download artifact
        uses: actions/download-artifact@v2
        with:
          name: ${{ env.ZIP_NAME }}

      - name: Step 2 ‚öôÔ∏è - Zip downloaded folder
        run: zip -r $ZIP_NAME.zip $ZIP_NAME

      - name: Step 3 ‚úàÔ∏è - Send it to Telegram private channel
        if: ${{ success() }}
        uses: appleboy/telegram-action@master
        env:
          RUN_NUMBER: ${{ github.run_number }}
          NEW_TAG: ${{ needs.build_docs.outputs.new_tag }}
          DROPBOX_SHARED_FOLDER: https://www.dropbox.com/sh/4c9e4n0umodm1wa/AAC4mZ3PqjjdvEWaCpzJBbB6a
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            build #${{ env.RUN_NUMBER }} ‚öôÔ∏è
            `${{ env.NEW_TAG }}` üè∑Ô∏è
            [main on Dropbox](${{ env.DROPBOX_SHARED_FOLDER }}) üóÑÔ∏è
            [see log run](${{ env.RUN_URL }}) üëÄ

            ``${{ github.event.head_commit.message }}``
          format: markdown
          disable_web_page_preview: true
          document: ${{ env.ZIP_NAME }}.zip

  upload_dropbox:
    name: 2. ‚è´ Carica main su Dropbox
    runs-on: ubuntu-latest
    needs: build_docs
    env:
      ZIP_NAME: ${{ needs.build_docs.outputs.zip_name }}
      MAIN_NAME: ${{ needs.build_docs.outputs.main_name }}
    steps:

      - name: Step 1 ‚è¨ - Download artifact
        uses: actions/download-artifact@v2
        with:
          name: ${{ env.ZIP_NAME }}

      - name: Step 2 ‚è´ - Upload to Dropbox
        uses: deka0106/upload-to-dropbox@v2
        env:
          DROPBOX_FOLDER: latex-algorithms
        with:
          dropbox_access_token: ${{ secrets.DROPBOX_ACCESS_TOKEN }}
          src: ${{ env.ZIP_NAME }}/${{ env.MAIN_NAME }}.pdf
          dest: /${{ env.DROPBOX_FOLDER }}/${{ env.MAIN_NAME }}.pdf
          mode: add
          mute: false

  create_release:
    name: 3. üì¶ Crea bozza release
    runs-on: ubuntu-latest
    needs: build_docs
    if: ${{ needs.build_docs.outputs.tag_part == ('major' || 'minor') }}
    env:
      ZIP_NAME: ${{ needs.build_docs.outputs.zip_name }}
      TAG_NAME: ${{ needs.build_docs.outputs.new_tag }}
      changelog: ${{ needs.build_docs.outputs.changelog }}
    steps:

      - name: Step 1 ‚úèÔ∏è - Create a draft release
        id: create-release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.new_tag }}
          release_name: Release ${{ env.new_tag }}
          body: |
            ${{ env.changelog }}
          draft: false
          prerelease: true

      - name: Step 2 ‚è¨ - (1/3) Download artifact
        uses: actions/download-artifact@v2
        with:
          name: ${{ env.ZIP_NAME }}

      - name: Step 2 ‚öôÔ∏è - (2/3) Zip downloaded folder
        run: zip -r $ZIP_NAME.zip $ZIP_NAME

      - name: Step 2 ‚è´ - (3/3) Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create-release.outputs.upload_url }}
          asset_path: ${{ env.ZIP_NAME }}.zip
          asset_name: ${{ env.ZIP_NAME }}.zip
          asset_content_type: application/zip
