name: Compila documento LaTeX
on:
  push:
    branches:       
      - main                    # Push events on main branch
      - preview                 # Push events on develop branch
    paths-ignore:
      - '*'                            # ignores root files
      - '.vscode/'                     # ignores suggestions
      - '.devcontainer/'               # ignores docker settings
      - 'docs/**'                      # ignores documentation
      - '.github/workflows/**'         # ignores all workflows
      - '!.github/workflows/build.yml' # un-ignores this workflow
      - 'src/build/'                   # ignores "build" dir inside "src" dir
      - '**.bat'                       # ignores windows scripts
  pull_request:
    types: [opened, reopened, synchronize]
    paths-ignore:
      - '**.md'
jobs:

  build_docs:
    name: Compila documento
    runs-on: ubuntu-latest
    outputs:
      zip_name: ${{ steps.name.outputs.ZIP_NAME }}
      main_name: ${{ steps.name.outputs.MAIN_NAME }}
      tag_name: ${{ steps.push-tag.outputs.new_tag }}
      part: ${{ steps.push-tag.outputs.part }}
    steps:
    
      - name: Step 0 üí° - Print enviroment variables
        run: |
          printf '%19s %s\n' "CI:"                 "$CI"
          printf '%19s %s\n' "GITHUB_WORKFLOW:"    "$GITHUB_WORKFLOW"
          printf '%19s %s\n' "GITHUB_RUN_ID:"      "$GITHUB_RUN_ID"
          printf '%19s %s\n' "GITHUB_RUN_NUMBER:"  "$GITHUB_RUN_NUMBER"
          printf '%19s %s\n' "GITHUB_ACTION:"      "$GITHUB_ACTION"
          printf '%19s %s\n' "GITHUB_ACTIONS:"     "$GITHUB_ACTIONS"
          printf '%19s %s\n' "GITHUB_ACTOR:"       "$GITHUB_ACTOR"
          printf '%19s %s\n' "GITHUB_REPOSITORY:"  "$GITHUB_REPOSITORY"
          printf '%19s %s\n' "GITHUB_EVENT_NAME:"  "$GITHUB_EVENT_NAME"
          printf '%19s %s\n' "GITHUB_EVENT_PATH:"  "$GITHUB_EVENT_PATH"
          printf '%19s %s\n' "GITHUB_WORKSPACE:"   "$GITHUB_WORKSPACE"
          printf '%19s %s\n' "GITHUB_SHA:"         "$GITHUB_SHA"
          printf '%19s %s\n' "GITHUB_REF:"         "$GITHUB_REF"
          printf '%19s %s\n' "GITHUB_HEAD_REF:"    "$GITHUB_HEAD_REF" # only for pull request
          printf '%19s %s\n' "GITHUB_BASE_REF:"    "$GITHUB_BASE_REF" # only for pull request
          printf '%19s %s\n' "GITHUB_SERVER_URL:"  "$GITHUB_SERVER_URL"
          printf '%19s %s\n' "GITHUB_API_URL:"     "$GITHUB_API_URL"
          printf '%19s %s\n' "GITHUB_GRAPHQL_URL:" "$GITHUB_GRAPHQL_URL"
          printf '%19s %s\n' "branch:"             "${GITHUB_REF#refs/heads/}"
          RUN_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}" >> $GITHUB_ENV
          printf '%19s %s\n' "RUN_URL:"            "$RUN_URL"

      # Set up container
      - name: Step 1 ‚òï - (1/3) Set up Java
        uses: actions/setup-java@v1
        with:
          java-version: '11'
      - name: Step 1 üêç - (2/3) Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8' # last cached version
      - name: Step 1 üêç - (3/3) Set up Python dependencies
        id: setup-python-dependencies
        run: pip install Pygments
    
      # Checkout branch and set environment variables
      - name: Step 2 üîß - (1/2) Checkout the HEAD
        uses: actions/checkout@v2 
      - name: Step 2 üîß - (2/2) Setting environment variables
        run: |
          echo "ROOT_DIR=$GITHUB_WORKSPACE" >> $GITHUB_ENV
          echo "BUILD_DIR=$GITHUB_WORKSPACE/src/build" >> $GITHUB_ENV
          echo "SCRIPT_DIR=$GITHUB_WORKSPACE/src/scripts/unix" >> $GITHUB_ENV
      
      # Compile LaTeX document
      - name: Step 3 ‚öôÔ∏è - (1/2) Compile LaTeX documents
        uses: xu-cheng/texlive-action/full@v1
        with:
          run: $SCRIPT_DIR/compile-project.sh
        
      - name: Step 3 üëÄ - (2/2) Log build
        uses: xu-cheng/texlive-action/full@v1
        with:
          run: source $SCRIPT_DIR/check-files.sh; isCompilationRanCorrectly

      - name: Step 4 üëª - (1/3) Install pdfsizeopt from source
        run: |
          mkdir -p bin/pdfsizeopt
          cd bin/pdfsizeopt
          wget -q -O pdfsizeopt_libexec_linux.tar.gz https://github.com/pts/pdfsizeopt/releases/download/2017-01-24/pdfsizeopt_libexec_linux-v3.tar.gz
          tar -xzf   pdfsizeopt_libexec_linux.tar.gz
          rm -f      pdfsizeopt_libexec_linux.tar.gz
          wget -q -O pdfsizeopt.single https://raw.githubusercontent.com/pts/pdfsizeopt/master/pdfsizeopt.single
          chmod +x   pdfsizeopt.single
          ln -s      pdfsizeopt.single pdfsizeopt
          echo "$GITHUB_WORKSPACE/bin/pdfsizeopt/" >> $GITHUB_PATH

      - name: Step 4 üëª - (2/3) Install ghostscript from source
        run: |
          mkdir -p bin/ghostscript
          cd  bin/ghostscript
          wget -q -O ghostscript-9.53.3-linux-x86_64.tgz https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9533/ghostscript-9.53.3-linux-x86_64.tgz
          tar -xzf   ghostscript-9.53.3-linux-x86_64.tgz
          rm -f      ghostscript-9.53.3-linux-x86_64.tgz
          cd         ghostscript-9.53.3-linux-x86_64
          ln -s      gs-9533-linux-x86_64 ghostscript
          echo "$GITHUB_WORKSPACE/bin/ghostscript/ghostscript-9.53.3-linux-x86_64/" >> $GITHUB_PATH

      - name: Step 4 üëª - (3/3) Compress files
        run: $SCRIPT_DIR/optimize-size.sh

      - name: Step 5 üîº - Bump version & push tag
        if: ${{ success() }}
        id: push-tag
        uses: anothrNick/github-tag-action@1.34.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: true
          RELEASE_BRANCHES: main
          DEFAULT_BUMP: patch # default: minor
          DRY_RUN: true # for debugging purposes
          PRERELEASE_SUFFIX: preview

      # Prepare variables used to name the files
      - name: Step 6 üîß - (1/2) Setting environment variables
        run: |
          echo "TAG_NAME=${{ steps.push-tag.outputs.new_tag }}" >> $GITHUB_ENV
          echo "DATE=$(date -d '+1 hour' +'%Y.%m.%d_%H.%M')" >> $GITHUB_ENV

      - name: Step 6 üîß - (2/2) Setting environment variables
        id: name
        run: |
          echo "ZIP_NAME=dispensa-$TAG_NAME-$DATE" >> $GITHUB_ENV
          echo "MAIN_NAME=main-$TAG_NAME-$DATE" >> $GITHUB_ENV
          echo "::set-output name=ZIP_NAME::dispensa-$TAG_NAME-$DATE"
          echo "::set-output name=MAIN_NAME::main-$TAG_NAME-$DATE"

      - name: Step 7 üîß - Create folder with pdfs
        run: |
          cd $BUILD_DIR
          mkdir $ZIP_NAME
          mv main.pdf $MAIN_NAME.pdf
          sudo mv -t $ZIP_NAME chapters $MAIN_NAME.pdf

      - name: ‚ö†Ô∏è notifica fallimento build ‚ö†Ô∏è
        if: ${{ failure() }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            @emanuelenardi *build ${GITHUB_RUN_NUMBER} fallita* üôÅ, [vedi log run]($RUN_URL)
          format: markdown
          disable_web_page_preview: true

      - name: Step 8 ‚è´ - Upload artifact
        if: ${{ success() }}
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.ZIP_NAME }}
          path: |
            ${{ env.BUILD_DIR }}
            !${{ env.BUILD_DIR }}/.gitignore
          if-no-files-found: error
          retention-days: 7

  # send_docs:
  #   name: Manda file zip a Telegram
  #   needs: build_docs
  #   runs-on: ubuntu-latest
  #   steps:

  #     - name: Step 0 - Setting üîß environment variables
  #       run: |
  #         echo "ZIP_NAME=${{ needs.build_docs.outputs.zip_name }}" >> $GITHUB_ENV

  #     - name: Step 1 - Download artifact ‚è¨
  #       uses: actions/download-artifact@v2
  #       with:
  #         name: ${{ env.ZIP_NAME }}

  #     - name: Step 2 - Zip downloaded folder
  #       run: zip -r $ZIP_NAME.zip $ZIP_NAME

  #     - name: Step 3 - Send it to Telegram private channel
  #       if: ${{ success() }}
  #       uses: appleboy/telegram-action@master
  #       with:
  #         to: ${{ secrets.TELEGRAM_TO }}
  #         token: ${{ secrets.TELEGRAM_TOKEN }}
  #         message: ${{ github.event.head_commit.message }}
  #         document: ${{ env.ZIP_NAME }}.zip
  
  # upload-dropbox:
  #   name: Carica il main su Dropbox
  #   needs: build_docs
  #   runs-on: ubuntu-latest
  #   steps:

  #     - name: Step 0 - Setting üîß environment variables
  #       run: |
  #         echo "ZIP_NAME=${{ needs.build_docs.outputs.zip_name }}" >> $GITHUB_ENV
  #         echo "MAIN_NAME=${{ needs.build_docs.outputs.main_name }}" >> $GITHUB_ENV

  #     - name: Step 1 - Download artifact ‚è¨
  #       uses: actions/download-artifact@v2
  #       with:
  #         name: ${{ env.ZIP_NAME }}

  #     - name: Step 2 - Extract main
  #       uses: deka0106/upload-to-dropbox@v2
  #       with:
  #         dropbox_access_token: ${{ secrets.DROPBOX_ACCESS_TOKEN }}
  #         src: ${{ env.ZIP_NAME }}/${{ env.MAIN_NAME }}.pdf
  #         dest: /latex-algorithms/${{ env.MAIN_NAME }}.pdf
  #         mode: "add"
  #         # mute: "true"

  # create_release:
  #   name: Crea una bozza di release
  #   needs: build_docs
  #   if: ${{ needs.build_docs.outputs.part == ('major' || 'minor') }}
  #   runs-on: ubuntu-latest
  #   steps:

  #     - name: Step 0 - Setting üîß environment variables
  #       run: |
  #         echo "ZIP_NAME=${{ needs.build_docs.outputs.zip_name }}" >> $GITHUB_ENV
  #         echo "TAG_NAME=${{ needs.build_docs.outputs.tag_name }}" >> $GITHUB_ENV

  #     - name: Step 1 - Create a draft release ‚úèÔ∏è
  #       id: create_release
  #       uses: actions/create-release@v1
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       with:
  #         tag_name: ${{ env.TAG_NAME }}
  #         release_name: Release ${{ env.TAG_NAME }}
  #         # draft: true
  #         prerelease: true

  #     - name: Step 2 - (1/3) Download artifact ‚è¨
  #       uses: actions/download-artifact@v2
  #       with:
  #         name: ${{ env.ZIP_NAME }}
      
  #     - name: Step 2 - (2/3) Zip downloaded folder
  #       run: zip -r $ZIP_NAME.zip $ZIP_NAME

  #     - name: Step 2 - (3/3) Upload release asset ‚è´
  #       id: upload-release-asset
  #       uses: actions/upload-release-asset@v1
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       with:
  #         upload_url: ${{ steps.create_release.outputs.upload_url }}
  #         asset_path: ${{ env.ZIP_NAME }}.zip
  #         asset_name: ${{ env.ZIP_NAME }}.zip
  #         asset_content_type: application/zip