name: Compila documento LaTeX
on:
  push:
    branches:       
      - main                    # Push events on main branch
      - preview                 # Push events on develop branch
    paths-ignore:
      - '*'                            # ignores root files
      - '.vscode/'                     # ignores suggestions
      - '.devcontainer/'               # ignores docker settings
      - 'docs/**'                      # ignores documentation
      - '.github/workflows/**'         # ignores all workflows
      - '!.github/workflows/build.yml' # un-ignores this workflow
      - 'src/build/'                   # ignores "build" dir inside "src" dir
      - '**.bat'                       # ignores windows scripts
  pull_request:
    types: [opened, reopened, synchronize]
    paths-ignore:
      - '**.md'
jobs:

  build_docs:
    name: Compila documento
    runs-on: ubuntu-latest
    env:
      RUN_URL: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID
    outputs:
      zip_name: ${{ steps.name.outputs.ZIP_NAME }}
      main_name: ${{ steps.name.outputs.MAIN_NAME }}
      part: ${{ steps.tag-version.outputs.part }}
      tag_name: ${{ steps.tag-version.outputs.new_tag }}
      changelog: ${{ steps.tag-version.outputs.changelog }}
    steps:
    
      - name: Step 0 üí° - Print enviroment variables
        run: |
          # USEFUL REFERENCES
          # https://stackoverflow.com/questions/16553089/dynamic-variable-names-in-bash
          print_var () { var=$1 ; printf '%18s %s\n' "var:" "${!var}"; }
          print_var "CI"
          print_var "GITHUB_WORKFLOW"
          print_var "GITHUB_RUN_ID"
          print_var "GITHUB_RUN_NUMBER"
          print_var "GITHUB_ACTION"
          print_var "GITHUB_ACTIONS"
          print_var "GITHUB_ACTOR"
          print_var "GITHUB_REPOSITORY"
          print_var "GITHUB_EVENT_NAME"
          print_var "GITHUB_WORKSPACE"
          print_var "GITHUB_SHA"
          print_var "GITHUB_REF"
          print_var "GITHUB_HEAD_REF" # only for pull requests
          print_var "GITHUB_BASE_REF" # only for pull requests
      
      - name: Step 0 üí° - Set enviroment variables
        run: |
          echo "GITHUB_SHA_SHORT=$(echo $GITHUB_SHA | cut -c 1-6)" >> $GITHUB_ENV
          echo "BRANCH=$GITHUB_REF#refs/heads/" >> $GITHUB_ENV
          echo "RUN_URL=$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" >> $GITHUB_ENV
          echo "RUN_NUMBER=$GITHUB_RUN_NUMBER" >> $GITHUB_ENV

      # Set up container
      - name: Step 1 ‚òï - (1/3) Set up Java
        uses: actions/setup-java@v1
        with:
          java-version: '11'
      - name: Step 1 üêç - (2/3) Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8' # last cached version
      - name: Step 1 üêç - (3/3) Set up Python dependencies
        id: setup-python-dependencies
        run: pip install Pygments
    
      # Checkout branch and set environment variables
      - name: Step 2 üîΩ - (1/2) Checkout the HEAD
        uses: actions/checkout@v2
      
      - name: Step 2 üîß - (2/2) Setting environment variables
        env:
          ROOT_DIR: "${GITHUB_WORKSPACE}"
          BUILD_DIR: "${GITHUB_WORKSPACE}/src/build"
          SCRIPTS_DIR: "${GITHUB_WORKSPACE}/src/scripts/unix"
        run: |
          echo $ROOT_DIR >> $GITHUB_ENV
          echo $BUILD_DIR >> $GITHUB_ENV
          echo $SCRIPTS_DIR >> $GITHUB_ENV
      
      # Compile LaTeX document
      - name: Step 3 ‚öôÔ∏è - (1/2) Compile LaTeX documents
        uses: xu-cheng/texlive-action/full@v1
        with:
          run: $SCRIPTS_DIR/compile-project.sh
        
      - name: Step 3 üëÄ - (2/2) Log build
        working-directory: $SCRIPTS_DIR
        run: source check-files.sh; isCompilationRanCorrectly

      - name: Step 4 üëª - (1/3) Install pdfsizeopt from source
        working-directory: $ROOT_DIR 
        run: |
          mkdir -p bin/pdfsizeopt
          cd bin/pdfsizeopt
          wget -q -O pdfsizeopt_libexec_linux.tar.gz https://github.com/pts/pdfsizeopt/releases/download/2017-01-24/pdfsizeopt_libexec_linux-v3.tar.gz
          tar -xzf pdfsizeopt_libexec_linux.tar.gz
          rm -f pdfsizeopt_libexec_linux.tar.gz
          wget -q -O pdfsizeopt.single https://raw.githubusercontent.com/pts/pdfsizeopt/master/pdfsizeopt.single
          chmod +x pdfsizeopt.single
          ln -s pdfsizeopt.single pdfsizeopt
          echo "$GITHUB_WORKSPACE/bin/pdfsizeopt/" >> $GITHUB_PATH

      - name: Step 4 üëª - (2/3) Install ghostscript from source
        working-directory: $ROOT_DIR
        run: |
          mkdir -p bin/ghostscript
          cd bin/ghostscript
          wget -q -O ghostscript-9.53.3-linux-x86_64.tgz https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs9533/ghostscript-9.53.3-linux-x86_64.tgz
          tar -xzf ghostscript-9.53.3-linux-x86_64.tgz
          rm -f ghostscript-9.53.3-linux-x86_64.tgz
          cd ghostscript-9.53.3-linux-x86_64
          ln -s gs-9533-linux-x86_64 ghostscript
          echo "$GITHUB_WORKSPACE/bin/ghostscript/ghostscript-9.53.3-linux-x86_64/" >> $GITHUB_PATH

      - name: Step 4 üëª - (3/3) Compress files
        working-directory: $SCRIPTS_DIR
        run: optimize-size.sh

      - name: Step 5 üîº - Bump version & push tag
        if: ${{ success() }}
        id: tag-version
        uses: mathieudutour/github-tag-action@v5.3
        env:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_branches: main
          pre_release_branches: preview
          default_bump: patch
          custom_release_rules: perf:major, feat:minor, fix:patch, hotfix:patch, pre-feat:preminor, pre-feat:preminor
          dry_run: true

      # Prepare variables used to name the files
      - name: Step 6 üîß - (1/2) Setting environment variables
        env:
          TAG_NAME: ${{ steps.tag-version.outputs.new_tag }}
          DATE: $(date -d '+1 hour' +'%Y.%m.%d_%H.%M')
        run: |
          echo "ZIP_NAME=dispensa-$TAG_NAME-$DATE" >> $GITHUB_ENV
          echo "MAIN_NAME=main-$TAG_NAME-$DATE" >> $GITHUB_ENV
          echo "::set-output name=ZIP_NAME::dispensa-$TAG_NAME-$DATE"
          echo "::set-output name=MAIN_NAME::main-$TAG_NAME-$DATE"

      - name: Step 7 üîß - Create folder with pdfs
        working-directory: $BUILD_DIR
        run: |
          mkdir $ZIP_NAME
          mv main.pdf $MAIN_NAME.pdf
          sudo mv -t $ZIP_NAME chapters $MAIN_NAME.pdf

      - name: ‚ö†Ô∏è notifica fallimento build ‚ö†Ô∏è
        if: ${{ failure() }}
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            @emanuelenardi *build $RUN_NUMBER fallita* üôÅ, [vedi log run]($RUN_URL)
          format: markdown
          disable_web_page_preview: true

      - name: Step 8 ‚è´ - Upload artifact
        if: ${{ success() }}
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.ZIP_NAME }}
          path: |
            ${{ env.BUILD_DIR }}
            !${{ env.BUILD_DIR }}/.gitignore
          if-no-files-found: error
          retention-days: 7

  # send_docs:
  #   name: Manda file zip a Telegram
  #   needs: build_docs
  #   runs-on: ubuntu-latest
  #   steps:

  #     - name: Step 0 - Setting üîß environment variables
  #       run: |
  #         echo "ZIP_NAME=${{ needs.build_docs.outputs.zip_name }}" >> $GITHUB_ENV

  #     - name: Step 1 - Download artifact ‚è¨
  #       uses: actions/download-artifact@v2
  #       with:
  #         name: ${{ env.ZIP_NAME }}

  #     - name: Step 2 - Zip downloaded folder
  #       run: zip -r $ZIP_NAME.zip $ZIP_NAME

  #     - name: Step 3 - Send it to Telegram private channel
  #       if: ${{ success() }}
  #       uses: appleboy/telegram-action@master
  #       with:
  #         to: ${{ secrets.TELEGRAM_TO }}
  #         token: ${{ secrets.TELEGRAM_TOKEN }}
  #         message: ${{ github.event.head_commit.message }}
  #         document: ${{ env.ZIP_NAME }}.zip
  
  # upload-dropbox:
  #   name: Carica il main su Dropbox
  #   needs: build_docs
  #   runs-on: ubuntu-latest
  #   steps:

  #     - name: Step 0 - Setting üîß environment variables
  #       run: |
  #         echo "ZIP_NAME=${{ needs.build_docs.outputs.zip_name }}" >> $GITHUB_ENV
  #         echo "MAIN_NAME=${{ needs.build_docs.outputs.main_name }}" >> $GITHUB_ENV

  #     - name: Step 1 - Download artifact ‚è¨
  #       uses: actions/download-artifact@v2
  #       with:
  #         name: ${{ env.ZIP_NAME }}

  #     - name: Step 2 - Extract main
  #       uses: deka0106/upload-to-dropbox@v2
  #       with:
  #         dropbox_access_token: ${{ secrets.DROPBOX_ACCESS_TOKEN }}
  #         src: ${{ env.ZIP_NAME }}/${{ env.MAIN_NAME }}.pdf
  #         dest: /latex-algorithms/${{ env.MAIN_NAME }}.pdf
  #         mode: "add"
  #         # mute: "true"

  # create_release:
  #   name: Crea una bozza di release
  #   needs: build_docs
  #   if: ${{ needs.build_docs.outputs.part == ('major' || 'minor') }}
  #   runs-on: ubuntu-latest
  #   steps:

  #     - name: Step 0 - Setting üîß environment variables
  #       run: |
  #         echo "ZIP_NAME=${{ needs.build_docs.outputs.zip_name }}" >> $GITHUB_ENV
  #         echo "TAG_NAME=${{ needs.build_docs.outputs.tag_name }}" >> $GITHUB_ENV

  #     - name: Step 1 - Create a draft release ‚úèÔ∏è
  #       id: create_release
  #       uses: actions/create-release@v1
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       with:
  #         tag_name: ${{ env.TAG_NAME }}
  #         release_name: Release ${{ env.TAG_NAME }}
  #         # draft: true
  #         prerelease: true

  #     - name: Step 2 - (1/3) Download artifact ‚è¨
  #       uses: actions/download-artifact@v2
  #       with:
  #         name: ${{ env.ZIP_NAME }}
      
  #     - name: Step 2 - (2/3) Zip downloaded folder
  #       run: zip -r $ZIP_NAME.zip $ZIP_NAME

  #     - name: Step 2 - (3/3) Upload release asset ‚è´
  #       id: upload-release-asset
  #       uses: actions/upload-release-asset@v1
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  #       with:
  #         upload_url: ${{ steps.create_release.outputs.upload_url }}
  #         asset_path: ${{ env.ZIP_NAME }}.zip
  #         asset_name: ${{ env.ZIP_NAME }}.zip
  #         asset_content_type: application/zip